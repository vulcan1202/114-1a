graph TD
    %% 定義樣式
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef server fill:#fff3e0,stroke:#ff6f00,stroke-width:2px;
    classDef ai fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
    classDef data fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;

    subgraph Client_Side ["前端應用層 (Client Side)"]
        User(("使用者"))
        App["React / React Native App"]:::client
    end

    subgraph Backend_Server ["後端服務層 (Backend Services)"]
        DjangoAPI["Django View API"]:::server
        DjangoChannels["Django Channels<br/>(WebSocket Consumer)"]:::server
    end

    subgraph Async_Queue ["訊息佇列與快取 (Message Broker)"]
        Redis["Redis<br/>(Task Queue & Channel Layer)"]:::data
    end

    subgraph AI_Processing ["AI 運算層 (Celery Workers)"]
        Celery["Celery Worker"]:::ai
        WhisperStream["Whisper Model<br/>(Streaming ASR)"]:::ai
        WhisperX["WhisperX Model<br/>(ASR + Diarization)"]:::ai
        Qwen["Qwen2.5 Model<br/>(Summarization)"]:::ai
    end

    subgraph Database ["資料儲存層 (Data Persistence)"]
        Postgres[("PostgreSQL")]:::data
        FileStore["File Storage<br/>(Media Files)"]:::data
    end

    %% 路徑 1: 即時串流 (Real-time Streaming Path)
    User -- "說話/錄音" --> App
    App -- "WebSocket (Audio Chunks)" --> DjangoChannels
    DjangoChannels -- "呼叫串流辨識" --> WhisperStream
    WhisperStream -- "辨識結果" --> DjangoChannels
    DjangoChannels -- "WebSocket 回傳文字" --> App

    %% 路徑 2: 非同步檔案處理 (Async Task Path)
    User -- "上傳錄音檔" --> App
    App -- "HTTP POST (Multipart)" --> DjangoAPI
    
    DjangoAPI -- "1. 儲存原始檔" --> FileStore
    DjangoAPI -- "2. 寫入任務記錄" --> Postgres
    DjangoAPI -- "3. 推送 Task" --> Redis
    DjangoAPI -. "回傳 Task ID" .-> App

    %% Celery 任務處理流程
    Redis -- "Pop Task" --> Celery
    Celery -- "載入檔案" --> FileStore
    
    %% AI 模型執行順序
    Celery --> WhisperX
    WhisperX -- "產出逐字稿 & 說話者標記" --> Postgres
    
    Celery -- "觸發摘要任務 (Chaining)" --> Qwen
    Qwen -- "讀取逐字稿" --> Postgres
    Qwen -- "寫入摘要結果" --> Postgres

    %% 狀態查詢
    App -. "輪詢/監聽狀態 (Polling)" .-> DjangoAPI
    DjangoAPI -. "查詢進度" .-> Postgres
